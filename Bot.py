import sqlite3
import logging
from datetime import datetime, timedelta
import asyncio
import time
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    Application, 
    CommandHandler, 
    MessageHandler, 
    ContextTypes, 
    filters
)
from telegram.constants import ParseMode

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
TOKEN = '8331737679:AAGmlvVP0KRsy5UYPClVZ7BzBCQkaXs2NXU'  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
# ===============================

# –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
MAIN_KEYBOARD = ReplyKeyboardMarkup(
    [
        ["üèãÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É"],
        ["üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "üìà –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü"],
        ["üèÜ –õ–∏–¥–µ—Ä—ã –º–µ—Å—è—Ü–∞", "üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å"],
        ["üë§ –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "üìÖ –°–µ–≥–æ–¥–Ω—è"]
    ],
    resize_keyboard=True,
    is_persistent=True
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('pushups.db')
    cursor = conn.cursor()
    
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS pushups (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        username TEXT,
        first_name TEXT,
        last_name TEXT,
        count INTEGER NOT NULL,
        date DATE NOT NULL
    )
    ''')
    
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS monthly_winners (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        username TEXT,
        month_year TEXT NOT NULL,
        prize_amount INTEGER DEFAULT 2000
    )
    ''')
    
    conn.commit()
    conn.close()

# –ó–∞–ø–∏—Å—å –æ—Ç–∂–∏–º–∞–Ω–∏–π
def add_pushups(user_id, username, first_name, last_name, count):
    conn = sqlite3.connect('pushups.db')
    cursor = conn.cursor()
    
    today = datetime.now().strftime('%Y-%m-%d')
    
    cursor.execute('''
    INSERT INTO pushups (user_id, username, first_name, last_name, count, date)
    VALUES (?, ?, ?, ?, ?, ?)
    ''', (user_id, username, first_name, last_name, count, today))
    
    conn.commit()
    conn.close()

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def get_statistics(period='all'):
    conn = sqlite3.connect('pushups.db')
    cursor = conn.cursor()
    
    if period == 'month':
        today = datetime.now()
        first_day = today.replace(day=1).strftime('%Y-%m-%d')
        if today.month == 12:
            last_day = today.replace(year=today.year+1, month=1, day=1) - timedelta(days=1)
        else:
            last_day = today.replace(month=today.month+1, day=1) - timedelta(days=1)
        last_day = last_day.strftime('%Y-%m-%d')
        
        cursor.execute('''
        SELECT user_id, 
               COALESCE(username, first_name || ' ' || COALESCE(last_name, '')),
               SUM(count) as total
        FROM pushups 
        WHERE date BETWEEN ? AND ?
        GROUP BY user_id
        ORDER BY total DESC
        ''', (first_day, last_day))
    else:
        cursor.execute('''
        SELECT user_id, 
               COALESCE(username, first_name || ' ' || COALESCE(last_name, '')),
               SUM(count) as total
        FROM pushups 
        GROUP BY user_id
        ORDER BY total DESC
        ''')
    
    results = cursor.fetchall()
    conn.close()
    
    total_all = sum([row[2] for row in results]) if results else 0
    return total_all, results

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    welcome_text = """
üèÜ <b>–ë–æ—Ç –¥–ª—è —É—á–µ—Ç–∞ –æ—Ç–∂–∏–º–∞–Ω–∏–π</b>

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫ –Ω–∏–∂–µ:

<b>–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>
üèãÔ∏è <b>–ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</b> - –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –æ—Ç–∂–∏–º–∞–Ω–∏—è
üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
üìà <b>–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</b> - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü
üèÜ <b>–õ–∏–¥–µ—Ä—ã –º–µ—Å—è—Ü–∞</b> - —Ç–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
üéâ <b>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</b> - –ø–æ–±–µ–¥–∏—Ç–µ–ª—å —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞

<b>–õ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
üë§ <b>–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> - –≤–∞—à–∏ –ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
üìÖ <b>–°–µ–≥–æ–¥–Ω—è</b> - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å

<b>üèÜ –ü—Ä–∏–∑—ã:</b>
–í –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 2000 —Ä—É–±–ª–µ–π!
"""
    
    await update.message.reply_text(
        welcome_text,
        reply_markup=MAIN_KEYBOARD,
        parse_mode=ParseMode.HTML
    )

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
async def cancel_input_timeout(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    user_id = job.data.get('user_id')
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    context.user_data.pop('waiting_for_count', None)
    context.user_data.pop('input_start_time', None)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
    await context.bot.send_message(
        chat_id=job.chat_id,
        text="‚è∞ <b>–í—Ä–µ–º—è –Ω–∞ –≤–≤–æ–¥ –∏—Å—Ç–µ–∫–ª–æ.</b>\n"
             "–ù–∞–∂–º–∏—Ç–µ 'üèãÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É' —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.",
        parse_mode=ParseMode.HTML,
        reply_markup=MAIN_KEYBOARD
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–Ω–æ–ø–æ–∫)
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = update.message.text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ —á–∏—Å–ª–∞ –æ—Ç–∂–∏–º–∞–Ω–∏–π
    if context.user_data.get('waiting_for_count'):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (5 —Å–µ–∫—É–Ω–¥)
        input_start_time = context.user_data.get('input_start_time')
        if input_start_time and time.time() - input_start_time > 5:
            # –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            context.user_data.pop('waiting_for_count', None)
            context.user_data.pop('input_start_time', None)
            
            # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if 'timeout_job' in context.user_data:
                context.user_data['timeout_job'].schedule_removal()
                context.user_data.pop('timeout_job', None)
            
            await update.message.reply_text(
                "‚è∞ <b>–í—Ä–µ–º—è –Ω–∞ –≤–≤–æ–¥ –∏—Å—Ç–µ–∫–ª–æ.</b>\n"
                "–ù–∞–∂–º–∏—Ç–µ 'üèãÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É' —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.",
                parse_mode=ParseMode.HTML,
                reply_markup=MAIN_KEYBOARD
            )
            return
        
        # –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –∏—Å—Ç–µ–∫–ª–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥
        await handle_pushup_count(update, context)
        return
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –æ–∂–∏–¥–∞–µ–º –≤–≤–æ–¥
    await handle_button_press(update, context)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫
async def handle_button_press(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    
    if text == "üèãÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É":
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
        context.user_data['waiting_for_count'] = True
        context.user_data['input_start_time'] = time.time()
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã –ø–æ —Ç–∞–π–º–∞—É—Ç—É (5 —Å–µ–∫—É–Ω–¥)
        job = context.job_queue.run_once(
            cancel_input_timeout,
            when=5,
            data={'user_id': update.effective_user.id},
            chat_id=update.effective_chat.id,
            name=f"input_timeout_{update.effective_user.id}"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Ç–º–µ–Ω—ã
        context.user_data['timeout_job'] = job
        
        await update.message.reply_text(
            "üí™ <b>–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π:</b>\n\n"
            "<i>–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 50</i>\n\n"
            "<i>–£ –≤–∞—Å –µ—Å—Ç—å 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–≤–æ–¥</i>\n"
            "<i>–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–∂–º–∏—Ç–µ /cancel</i>",
            parse_mode=ParseMode.HTML,
            reply_markup=ReplyKeyboardMarkup([["/cancel"]], resize_keyboard=True)
        )
    
    elif text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞":
        total, stats = get_statistics('all')
        message = f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</b>\n\n"
        message += f"<b>–í—Å–µ–≥–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π:</b> {total} —Ä–∞–∑\n\n"
        
        if stats:
            for i, (user_id, name, user_total) in enumerate(stats, 1):
                if i <= 10:
                    message += f"{i}. {name} - {user_total} —Ä–∞–∑\n"
            if len(stats) > 10:
                message += f"\n...–∏ –µ—â—ë {len(stats) - 10} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
        else:
            message += "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç–∂–∏–º–∞–Ω–∏—è—Ö"
        
        await update.message.reply_text(message, parse_mode=ParseMode.HTML)
    
    elif text == "üìà –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü":
        total, stats = get_statistics('month')
        today = datetime.now()
        month_name = today.strftime('%B %Y')
        
        message = f"üìà <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ {month_name}</b>\n\n"
        message += f"<b>–í—Å–µ–≥–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π:</b> {total} —Ä–∞–∑\n\n"
        
        if stats:
            for i, (user_id, name, user_total) in enumerate(stats, 1):
                if i <= 10:
                    message += f"{i}. {name} - {user_total} —Ä–∞–∑\n"
            if len(stats) > 10:
                message += f"\n...–∏ –µ—â—ë {len(stats) - 10} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
        else:
            message += "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü"
        
        await update.message.reply_text(message, parse_mode=ParseMode.HTML)
    
    elif text == "üèÜ –õ–∏–¥–µ—Ä—ã –º–µ—Å—è—Ü–∞":
        total, stats = get_statistics('month')
        today = datetime.now()
        month_name = today.strftime('%B %Y')
        
        if stats:
            message = f"üèÜ <b>–õ–∏–¥–µ—Ä—ã {month_name}</b>\n\n"
            
            top_users = stats[:5]
            
            for i, (user_id, name, user_total) in enumerate(top_users, 1):
                if i == 1:
                    message += f"ü•á <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
                elif i == 2:
                    message += f"ü•à <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
                elif i == 3:
                    message += f"ü•â <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
                else:
                    message += f"{i}. <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
            
            message += f"\n<b>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {len(stats)}"
            message += f"\n<b>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</b> {total}"
        else:
            message = "üìä –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü"
        
        await update.message.reply_text(message, parse_mode=ParseMode.HTML)
    
    elif text == "üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å":
        total, stats = get_statistics('month')
        
        if stats:
            winner_id, winner_name, winner_total = stats[0]
            today = datetime.now()
            month_name = today.strftime('%B %Y')
            
            message = (
                f"üéâ <b>–ü–û–ë–ï–î–ò–¢–ï–õ–¨ {month_name.upper()}</b>\n\n"
                f"ü•á <b>{winner_name}</b>\n\n"
                f"<b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π:</b> {winner_total}\n"
                f"<b>–ü—Ä–∏–∑:</b> 2000 —Ä—É–±–ª–µ–π\n\n"
                f"<i>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è! üéä</i>"
            )
        else:
            message = "üìä –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü"
        
        await update.message.reply_text(message, parse_mode=ParseMode.HTML)
    
    elif text == "üë§ –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞":
        await my_stats(update, context)
    
    elif text == "üìÖ –°–µ–≥–æ–¥–Ω—è":
        await today_stats(update, context)
    
    else:
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å —á–∞—Ç
        pass

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –æ—Ç–∂–∏–º–∞–Ω–∏–π
async def handle_pushup_count(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = update.message.text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–º–µ–Ω–∞ –ª–∏ —ç—Ç–æ
    if text.lower() in ['/cancel', '–æ—Ç–º–µ–Ω–∞', 'cancel']:
        context.user_data.pop('waiting_for_count', None)
        context.user_data.pop('input_start_time', None)
        
        # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if 'timeout_job' in context.user_data:
            context.user_data['timeout_job'].schedule_removal()
            context.user_data.pop('timeout_job', None)
        
        await update.message.reply_text(
            "‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.",
            reply_markup=MAIN_KEYBOARD
        )
        return
    
    try:
        count = int(text)
        if count <= 0:
            await update.message.reply_text(
                "‚ùå <b>–ß–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.</b>\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ (—É –≤–∞—Å 5 —Å–µ–∫—É–Ω–¥):",
                parse_mode=ParseMode.HTML
            )
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
            context.user_data['input_start_time'] = time.time()
            return
        
        if count > 10000:
            await update.message.reply_text(
                "üòÆ <b>–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ!</b>\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—É –≤–∞—Å 5 —Å–µ–∫—É–Ω–¥):",
                parse_mode=ParseMode.HTML
            )
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
            context.user_data['input_start_time'] = time.time()
            return
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –±–∞–∑—É
        add_pushups(
            user.id,
            user.username,
            user.first_name,
            user.last_name,
            count
        )
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä
        context.user_data.pop('waiting_for_count', None)
        context.user_data.pop('input_start_time', None)
        if 'timeout_job' in context.user_data:
            context.user_data['timeout_job'].schedule_removal()
            context.user_data.pop('timeout_job', None)
        
        await update.message.reply_text(
            f"‚úÖ <b>–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª {count} –æ—Ç–∂–∏–º–∞–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è!</b>\n\n"
            f"<i>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™</i>",
            parse_mode=ParseMode.HTML,
            reply_markup=MAIN_KEYBOARD
        )
        
    except ValueError:
        await update.message.reply_text(
            "‚ùå <b>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.</b>\n"
            "–ü—Ä–∏–º–µ—Ä: 50\n\n"
            "<i>–£ –≤–∞—Å 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–≤–æ–¥</i>\n"
            "<i>–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–∂–º–∏—Ç–µ /cancel</i>",
            parse_mode=ParseMode.HTML
        )
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
        context.user_data['input_start_time'] = time.time()

# –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–º–µ–Ω—ã
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if context.user_data.get('waiting_for_count'):
        context.user_data.pop('waiting_for_count', None)
        context.user_data.pop('input_start_time', None)
        
        # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if 'timeout_job' in context.user_data:
            context.user_data['timeout_job'].schedule_removal()
            context.user_data.pop('timeout_job', None)
        
        await update.message.reply_text(
            "‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.",
            reply_markup=MAIN_KEYBOARD
        )
    else:
        await update.message.reply_text(
            "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã.",
            reply_markup=MAIN_KEYBOARD
        )

# –õ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def my_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    conn = sqlite3.connect('pushups.db')
    cursor = conn.cursor()
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    cursor.execute('''
    SELECT SUM(count) as total,
           COUNT(DISTINCT date) as days,
           AVG(count) as average,
           MAX(count) as max_count
    FROM pushups 
    WHERE user_id = ?
    ''', (user.id,))
    
    total_stats = cursor.fetchone()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü
    today = datetime.now()
    first_day = today.replace(day=1).strftime('%Y-%m-%d')
    last_day = (today.replace(month=today.month+1, day=1) - timedelta(days=1)).strftime('%Y-%m-%d')
    
    cursor.execute('''
    SELECT SUM(count) as month_total,
           COUNT(DISTINCT date) as month_days
    FROM pushups 
    WHERE user_id = ? AND date BETWEEN ? AND ?
    ''', (user.id, first_day, last_day))
    
    month_stats = cursor.fetchone()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    today_str = today.strftime('%Y-%m-%d')
    cursor.execute('''
    SELECT SUM(count) as today_total
    FROM pushups 
    WHERE user_id = ? AND date = ?
    ''', (user.id, today_str))
    
    today_stats = cursor.fetchone()
    
    # –ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ –∑–∞ –º–µ—Å—è—Ü
    cursor.execute('''
    SELECT user_id, SUM(count) as total
    FROM pushups 
    WHERE date BETWEEN ? AND ?
    GROUP BY user_id
    ORDER BY total DESC
    ''', (first_day, last_day))
    
    month_ranking = cursor.fetchall()
    user_rank = None
    for i, (uid, total) in enumerate(month_ranking, 1):
        if uid == user.id:
            user_rank = i
            break
    
    conn.close()
    
    total = total_stats[0] or 0
    days = total_stats[1] or 0
    average = total_stats[2] or 0
    max_count = total_stats[3] or 0
    month_total = month_stats[0] or 0
    month_days = month_stats[1] or 0
    today_total = today_stats[0] or 0
    
    user_name = user.username or user.first_name or "–£—á–∞—Å—Ç–Ω–∏–∫"
    
    message = f"üë§ <b>–õ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ {user_name}</b>\n\n"
    
    message += f"<b>–°–µ–≥–æ–¥–Ω—è:</b> {int(today_total)} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
    message += f"<b>–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:</b> {int(month_total)} ({month_days} –¥–Ω–µ–π)\n"
    if user_rank:
        message += f"<b>–ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ:</b> {user_rank}\n"
    message += f"<b>–í—Å–µ–≥–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π:</b> {int(total)}\n"
    message += f"<b>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–Ω–µ–π:</b> {days}\n"
    if days > 0:
        message += f"<b>–°—Ä–µ–¥–Ω–µ–µ –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É:</b> {int(average)}\n"
        message += f"<b>–†–µ–∫–æ—Ä–¥ –∑–∞ —Ä–∞–∑:</b> {int(max_count)}\n"
    
    if days > 0:
        message += f"\n<b>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™</b>"
    else:
        message += f"\n<b>–ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É! üèÉ‚Äç‚ôÇÔ∏è</b>"
    
    await update.message.reply_text(message, parse_mode=ParseMode.HTML)

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
async def today_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect('pushups.db')
    cursor = conn.cursor()
    
    today = datetime.now().strftime('%Y-%m-%d')
    
    cursor.execute('''
    SELECT COALESCE(username, first_name || ' ' || COALESCE(last_name, '')),
           SUM(count) as total
    FROM pushups 
    WHERE date = ?
    GROUP BY user_id
    ORDER BY total DESC
    ''', (today,))
    
    results = cursor.fetchall()
    conn.close()
    
    total_today = sum([row[1] for row in results]) if results else 0
    
    message = f"üìÖ <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è ({today})</b>\n\n"
    message += f"<b>–í—Å–µ–≥–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π:</b> {total_today} —Ä–∞–∑\n\n"
    
    if results:
        message += "<b>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</b>\n"
        for i, (name, user_total) in enumerate(results, 1):
            if i <= 10:
                message += f"{i}. {name} - {user_total} —Ä–∞–∑\n"
        if len(results) > 10:
            message += f"\n...–∏ –µ—â—ë {len(results) - 10} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
    else:
        message += "–°–µ–≥–æ–¥–Ω—è –µ—â–µ –Ω–∏–∫—Ç–æ –Ω–µ –¥–µ–ª–∞–ª –æ—Ç–∂–∏–º–∞–Ω–∏—è üò¥\n\n"
        message += "–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üí™"
    
    await update.message.reply_text(message, parse_mode=ParseMode.HTML)

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
async def weekly(update: Update, context: ContextTypes.DEFAULT_TYPE):
    total, stats = get_statistics('month')
    today = datetime.now()
    month_name = today.strftime('%B %Y')
    
    if stats:
        message = f"üèÜ <b>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ {month_name}</b>\n\n"
        
        top_users = stats[:5]
        
        for i, (user_id, name, user_total) in enumerate(top_users, 1):
            if i == 1:
                message += f"ü•á <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
            elif i == 2:
                message += f"ü•à <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
            elif i == 3:
                message += f"ü•â <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
            else:
                message += f"{i}. <b>{name}</b> - {user_total} –æ—Ç–∂–∏–º–∞–Ω–∏–π\n"
        
        message += f"\n<b>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {len(stats)}"
        message += f"\n<b>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</b> {total}"
        
        await update.message.reply_text(message, parse_mode=ParseMode.HTML)
    else:
        await update.message.reply_text("üìä –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü")

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ–±—â–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
async def all_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    total, stats = get_statistics('all')
    message = f"üìä <b>–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</b>\n\n"
    message += f"<b>–í—Å–µ–≥–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π:</b> {total} —Ä–∞–∑\n\n"
    
    if stats:
        message += "<b>–¢–æ–ø-10 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b>\n"
        for i, (user_id, name, user_total) in enumerate(stats[:10], 1):
            message += f"{i}. {name} - {user_total} —Ä–∞–∑\n"
        
        if len(stats) > 10:
            message += f"\n...–∏ –µ—â—ë {len(stats) - 10} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
    else:
        message += "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç–∂–∏–º–∞–Ω–∏—è—Ö"
    
    await update.message.reply_text(message, parse_mode=ParseMode.HTML)

# –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
<b>üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>

/start - –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/weekly - –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
/allstats - –û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
/cancel - –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ

<b>üéØ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞
2. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É"
3. –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥
4. –°–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏

<b>üèÜ –ü—Ä–∏–∑—ã:</b>
–í –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 2000 —Ä—É–±–ª–µ–π!

<b>üì± –ö–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π!</b>
"""
    await update.message.reply_text(help_text, parse_mode=ParseMode.HTML)

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
async def reset_db(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    # –ó–∞–º–µ–Ω–∏—Ç–µ '@Kovalevev' –Ω–∞ –≤–∞—à ID
    if str(user.id) == '@Kovalevev':  
        init_db()
        await update.message.reply_text("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–±—Ä–æ—à–µ–Ω–∞")
    else:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    init_db()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = Application.builder().token(TOKEN).build()
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("weekly", weekly))
    application.add_handler(CommandHandler("allstats", all_stats))
    application.add_handler(CommandHandler("cancel", cancel))
    application.add_handler(CommandHandler("reset", reset_db))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(
        MessageHandler(
            filters.TEXT & ~filters.COMMAND,
            handle_message
        )
    )
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    print("=" * 50)
    print("ü§ñ –ë–æ—Ç –¥–ª—è —É—á–µ—Ç–∞ –æ—Ç–∂–∏–º–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω!")
    print("üì± –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Android —á–µ—Ä–µ–∑ Pydroid 3")
    print("=" * 50)
    print("\nüéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:")
    print("‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞")
    print("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ —á–∏—Å–ª–∞")
    print("‚úÖ –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–≤–æ–¥ –æ—Ç–∂–∏–º–∞–Ω–∏–π")
    print("‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è")
    print("=" * 50)
    print("\nüí° –°–æ–≤–µ—Ç:")
    print("1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É")
    print("2. –ù–∞–∑–Ω–∞—á—å—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
    print("3. –ù–∞–ø–∏—à–∏—Ç–µ –≤ –≥—Ä—É–ø–ø–µ /start")
    print("4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
    print("=" * 50)
    
    try:
        application.run_polling(allowed_updates=Update.ALL_TYPES)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞")

if __name__ == '__main__':
    main()
